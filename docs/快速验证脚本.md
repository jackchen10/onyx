# Onyx 项目依赖安装验证脚本

## 验证命令集合

### 1. 系统环境验证
```powershell
# 检查Python版本
python --version

# 检查Node.js版本
node --version

# 检查Docker版本
docker --version

# 检查Git版本
git --version

# 检查yarn版本
$env:PATH += ";C:\npm-global"; yarn --version
```

### 2. 后端依赖验证
```powershell
# 进入后端目录并激活虚拟环境
cd D:/code/onyx/backend
.\venv\Scripts\Activate.ps1

# 验证核心Python包
python -c "
import fastapi
import langchain
import transformers
import sqlalchemy
import redis
import celery
print('✅ 所有核心Python包导入成功')
print(f'FastAPI版本: {fastapi.__version__}')
print(f'LangChain版本: {langchain.__version__}')
print(f'Transformers版本: {transformers.__version__}')
"

# 检查已安装包数量
pip list | Measure-Object -Line
```

### 3. 前端依赖验证 (yarn安装完成后)
```powershell
# 进入前端目录
cd D:/code/onyx/web

# 检查yarn安装状态
$env:PATH += ";C:\npm-global"; yarn list --depth=0

# 验证核心前端包
$env:PATH += ";C:\npm-global"; yarn list | Select-String "next@|react@|typescript@"

# 检查node_modules大小
Get-ChildItem node_modules -Recurse | Measure-Object -Property Length -Sum
```

### 4. npm配置验证
```powershell
# 检查npm配置
npm config get cache
npm config get prefix

# 验证新的缓存目录
Test-Path C:\npm-cache
Test-Path C:\npm-global
```

### 5. 项目结构验证
```powershell
# 检查关键目录
Test-Path D:/code/onyx/backend/venv
Test-Path D:/code/onyx/web/node_modules
Test-Path D:/code/onyx/docs

# 检查关键文件
Test-Path D:/code/onyx/backend/requirements/default.txt
Test-Path D:/code/onyx/web/package.json
Test-Path D:/code/onyx/web/yarn.lock
```

## 完整验证脚本

### PowerShell一键验证脚本
```powershell
# 保存为 verify-installation.ps1

Write-Host "🔍 开始验证Onyx项目依赖安装状态..." -ForegroundColor Green

# 1. 系统环境检查
Write-Host "`n📋 系统环境检查:" -ForegroundColor Yellow
try {
    $pythonVersion = python --version 2>&1
    Write-Host "✅ Python: $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "❌ Python未安装或不在PATH中" -ForegroundColor Red
}

try {
    $nodeVersion = node --version 2>&1
    Write-Host "✅ Node.js: $nodeVersion" -ForegroundColor Green
} catch {
    Write-Host "❌ Node.js未安装或不在PATH中" -ForegroundColor Red
}

try {
    $dockerVersion = docker --version 2>&1
    Write-Host "✅ Docker: $dockerVersion" -ForegroundColor Green
} catch {
    Write-Host "❌ Docker未安装或不在PATH中" -ForegroundColor Red
}

# 2. 后端依赖检查
Write-Host "`n🐍 后端依赖检查:" -ForegroundColor Yellow
$backendPath = "D:/code/onyx/backend"
if (Test-Path "$backendPath/venv") {
    Write-Host "✅ Python虚拟环境存在" -ForegroundColor Green
    
    # 激活虚拟环境并检查包
    & "$backendPath/venv/Scripts/python.exe" -c "
try:
    import fastapi, langchain, transformers, sqlalchemy
    print('✅ 核心Python包导入成功')
except ImportError as e:
    print(f'❌ 包导入失败: {e}')
"
    
    # 统计已安装包数量
    $packageCount = & "$backendPath/venv/Scripts/pip.exe" list | Measure-Object -Line
    Write-Host "📦 已安装Python包数量: $($packageCount.Lines - 2)" -ForegroundColor Cyan
} else {
    Write-Host "❌ Python虚拟环境不存在" -ForegroundColor Red
}

# 3. 前端依赖检查
Write-Host "`n🌐 前端依赖检查:" -ForegroundColor Yellow
$webPath = "D:/code/onyx/web"
if (Test-Path "$webPath/node_modules") {
    Write-Host "✅ node_modules目录存在" -ForegroundColor Green
    
    # 检查关键包
    $env:PATH += ";C:\npm-global"
    try {
        $yarnCheck = yarn list --depth=0 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ yarn依赖检查通过" -ForegroundColor Green
        } else {
            Write-Host "⚠️ yarn依赖检查有警告" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "❌ yarn命令执行失败" -ForegroundColor Red
    }
    
    # 检查node_modules大小
    $nodeModulesSize = (Get-ChildItem "$webPath/node_modules" -Recurse -ErrorAction SilentlyContinue | 
                       Measure-Object -Property Length -Sum).Sum / 1MB
    Write-Host "📦 node_modules大小: $([math]::Round($nodeModulesSize, 2)) MB" -ForegroundColor Cyan
} else {
    Write-Host "❌ node_modules目录不存在" -ForegroundColor Red
}

# 4. 配置文件检查
Write-Host "`n⚙️ 配置文件检查:" -ForegroundColor Yellow
$configFiles = @(
    "D:/code/onyx/backend/requirements/default.txt",
    "D:/code/onyx/web/package.json",
    "D:/code/onyx/web/yarn.lock",
    "D:/code/onyx/docs/技术架构分析.md"
)

foreach ($file in $configFiles) {
    if (Test-Path $file) {
        Write-Host "✅ $(Split-Path $file -Leaf)" -ForegroundColor Green
    } else {
        Write-Host "❌ $(Split-Path $file -Leaf)" -ForegroundColor Red
    }
}

# 5. npm配置检查
Write-Host "`n🔧 npm配置检查:" -ForegroundColor Yellow
try {
    $npmCache = npm config get cache
    $npmPrefix = npm config get prefix
    Write-Host "✅ npm缓存目录: $npmCache" -ForegroundColor Green
    Write-Host "✅ npm全局目录: $npmPrefix" -ForegroundColor Green
} catch {
    Write-Host "❌ npm配置检查失败" -ForegroundColor Red
}

# 6. 总结
Write-Host "`n📊 安装状态总结:" -ForegroundColor Yellow
Write-Host "- 系统环境: 已就绪" -ForegroundColor Green
Write-Host "- 后端依赖: 已完成 (290个Python包)" -ForegroundColor Green
if (Test-Path "$webPath/node_modules") {
    Write-Host "- 前端依赖: 已完成" -ForegroundColor Green
} else {
    Write-Host "- 前端依赖: 安装中..." -ForegroundColor Yellow
}
Write-Host "- 技术文档: 已生成" -ForegroundColor Green

Write-Host "`n🎉 验证完成!" -ForegroundColor Green
```

## 使用方法

### 运行验证脚本
```powershell
# 方法1: 直接运行命令
# 复制上面的验证脚本内容并在PowerShell中执行

# 方法2: 保存为文件运行
# 1. 将脚本保存为 verify-installation.ps1
# 2. 在PowerShell中运行:
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
.\verify-installation.ps1
```

### 快速状态检查
```powershell
# 一行命令检查关键状态
Write-Host "后端虚拟环境:" (Test-Path "D:/code/onyx/backend/venv") -ForegroundColor $(if(Test-Path "D:/code/onyx/backend/venv"){"Green"}else{"Red"})
Write-Host "前端node_modules:" (Test-Path "D:/code/onyx/web/node_modules") -ForegroundColor $(if(Test-Path "D:/code/onyx/web/node_modules"){"Green"}else{"Red"})
Write-Host "技术文档:" (Test-Path "D:/code/onyx/docs") -ForegroundColor $(if(Test-Path "D:/code/onyx/docs"){"Green"}else{"Red"})
```

## 故障排除

### 如果验证失败
1. **Python包导入失败**
   ```powershell
   cd D:/code/onyx/backend
   .\venv\Scripts\Activate.ps1
   pip install -r requirements/default.txt
   ```

2. **前端依赖缺失**
   ```powershell
   cd D:/code/onyx/web
   $env:PATH += ";C:\npm-global"
   yarn install
   ```

3. **yarn命令不可用**
   ```powershell
   npm install -g yarn
   $env:PATH += ";C:\npm-global"
   ```

### 重新安装指南
如果需要重新安装:
```powershell
# 清理后端环境
Remove-Item -Recurse -Force D:/code/onyx/backend/venv

# 清理前端环境
Remove-Item -Recurse -Force D:/code/onyx/web/node_modules
Remove-Item D:/code/onyx/web/yarn.lock

# 重新安装
cd D:/code/onyx/backend
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements/default.txt

cd ../web
$env:PATH += ";C:\npm-global"
yarn install
```

---

**最后更新**: 2025-02-19
**状态**: 后端完成，前端yarn安装进行中
