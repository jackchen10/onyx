# Onyx 项目依赖分析与安装指南

## 系统环境检查结果

✅ **当前系统环境状态:**
- Python: 3.12.1 (要求: 3.11+)
- Node.js: v22.17.1 (要求: 18+)
- Docker: 25.0.3 (要求: 20+)
- Git: 2.45.1 (要求: 2.0+)

## 核心依赖分析

### 1. 系统级依赖

| 组件 | 版本要求 | 当前版本 | 状态 | 用途 |
|------|----------|----------|------|------|
| Python | 3.11+ | 3.12.1 | ✅ | 后端运行环境 |
| Node.js | 18+ | 22.17.1 | ✅ | 前端构建和运行 |
| Docker | 20+ | 25.0.3 | ✅ | 容器化部署 |
| Git | 2.0+ | 2.45.1 | ✅ | 版本控制 |

### 2. 后端核心依赖

#### 主要框架和库
```txt
fastapi==0.115.12           # Web框架
uvicorn==0.21.1            # ASGI服务器
sqlalchemy==2.0.15         # ORM框架
alembic==1.10.4            # 数据库迁移
asyncpg==0.30.0            # PostgreSQL异步驱动
redis==5.0.8               # Redis客户端
celery==5.5.1              # 任务队列
```

#### AI/ML相关依赖
```txt
langchain==0.3.23          # AI工作流框架
langchain-community==0.3.21
langchain-core==0.3.51
langchain-openai==0.2.9
transformers==4.49.0       # 模型推理
sentence-transformers      # 文本嵌入
huggingface-hub==0.29.0    # 模型下载
openai==1.75.0             # OpenAI API
litellm==1.72.2            # 多模型统一接口
```

#### 文档处理依赖
```txt
beautifulsoup4==4.12.3     # HTML解析
lxml==5.3.0                # XML/HTML处理
pypdf==5.4.0               # PDF处理
python-docx==1.1.2         # Word文档处理
python-pptx==0.6.23        # PowerPoint处理
unstructured==0.15.1       # 非结构化文档处理
```

#### 连接器依赖
```txt
google-api-python-client==2.86.0  # Google API
slack-sdk==3.20.2                 # Slack集成
atlassian-python-api==3.41.16     # Confluence/Jira
Office365-REST-Python-Client==2.5.9  # Microsoft 365
simple-salesforce==1.12.6         # Salesforce
```

### 3. 前端核心依赖

#### 主要框架
```json
{
  "next": "^15.2.4",           // Next.js框架
  "react": "^18.3.1",          // React库
  "react-dom": "^18.3.1",      // React DOM
  "typescript": "5.0.3"        // TypeScript
}
```

#### UI组件库
```json
{
  "@radix-ui/react-*": "^1.x", // 无障碍UI组件
  "@headlessui/react": "^2.2.0", // Headless UI
  "tailwindcss": "^3.3.1",     // CSS框架
  "lucide-react": "^0.454.0"   // 图标库
}
```

#### 状态管理和数据获取
```json
{
  "swr": "^2.1.5",            // 数据获取
  "formik": "^2.2.9",         // 表单处理
  "yup": "^1.4.0"             // 表单验证
}
```

### 4. 数据库依赖

#### PostgreSQL (推荐版本: 14+)
- 主数据库，存储用户、文档、聊天记录等
- 支持向量扩展 (pgvector) 用于相似度搜索

#### Redis (推荐版本: 6+)
- 缓存层，存储会话、临时数据
- 任务队列后端 (Celery)

### 5. 可选依赖

#### 向量数据库
- **Qdrant**: 专业向量数据库
- **Weaviate**: 向量搜索引擎
- **Chroma**: 轻量级向量数据库

#### 对象存储
- **MinIO**: S3兼容的本地对象存储
- **AWS S3**: 云端对象存储
- **Azure Blob**: Azure云存储

## 安装步骤

### 步骤1: 创建Python虚拟环境

```powershell
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
.\venv\Scripts\Activate.ps1

# 或者使用 (Windows CMD)
venv\Scripts\activate.bat
```

### 步骤2: 安装后端依赖 ✅ 已完成

```powershell
# 升级pip
.\venv\Scripts\python.exe -m pip install --upgrade pip

# 安装基础依赖 (已成功安装290个包)
pip install -r requirements/default.txt

# 安装开发依赖 (可选)
pip install -r requirements/dev.txt

# 安装企业版依赖 (如果需要)
pip install -r requirements/ee.txt
```

**✅ 后端依赖安装状态：成功**
- 已安装290个Python包
- 包括FastAPI、LangChain、Transformers等核心依赖
- 虚拟环境位置：`backend/venv/`

### 步骤3: 安装前端依赖 ⚠️ 需要解决权限问题

```powershell
# 进入前端目录
cd ../web

# 方法1: 使用管理员权限运行PowerShell
# 右键点击PowerShell -> "以管理员身份运行"
npm install

# 方法2: 清理npm缓存并重试
npm cache clean --force
npm install

# 方法3: 使用yarn (推荐)
npm install -g yarn
yarn install

# 方法4: 使用pnpm (更快)
npm install -g pnpm
pnpm install
```

**⚠️ 前端依赖安装状态：遇到权限问题**
- 错误原因：npm缓存目录权限不足
- 解决方案：使用管理员权限或替代包管理器

### 步骤4: 数据库设置

#### 使用Docker Compose (推荐)
```powershell
# 返回项目根目录
cd ..

# 启动数据库服务
docker-compose -f deployment/docker_compose/docker-compose.dev.yml up -d relational_db cache
```

#### 手动安装PostgreSQL和Redis
```powershell
# 使用Chocolatey安装 (Windows)
choco install postgresql redis-64

# 或使用Scoop
scoop install postgresql redis
```

### 步骤5: 环境配置

```powershell
# 复制环境变量模板
cp deployment/docker_compose/env.dev.template .env

# 编辑环境变量
notepad .env
```

### 步骤6: 数据库初始化

```powershell
# 进入后端目录
cd backend

# 运行数据库迁移
alembic upgrade head
```

## 快速启动脚本

### 开发环境启动
```powershell
# 使用Docker Compose启动所有服务
docker-compose -f deployment/docker_compose/docker-compose.dev.yml up -d

# 或分别启动服务
# 1. 启动后端
cd backend
.\venv\Scripts\Activate.ps1
uvicorn onyx.main:app --reload --port 8080

# 2. 启动前端 (新终端)
cd web
npm run dev
```

## 常见问题解决

### 1. Python依赖安装失败
```powershell
# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像源
pip install -r requirements/default.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 2. Node.js依赖安装失败
```powershell
# 清理缓存
npm cache clean --force

# 使用国内镜像源
npm config set registry https://registry.npmmirror.com/
npm install
```

### 3. Docker权限问题
```powershell
# 确保Docker Desktop正在运行
# 以管理员身份运行PowerShell
```

### 4. 数据库连接问题
```powershell
# 检查PostgreSQL服务状态
docker ps | grep postgres

# 检查端口占用
netstat -an | findstr :5432
```

## 性能优化建议

### 1. Python环境优化
- 使用 `pip-tools` 管理依赖版本
- 启用 `pip` 缓存加速安装
- 考虑使用 `conda` 管理科学计算库

### 2. Node.js环境优化
- 使用 `pnpm` 替代 `npm` 提升安装速度
- 启用 `npm` 缓存
- 使用 `.nvmrc` 固定Node.js版本

### 3. 数据库优化
- 配置PostgreSQL连接池
- 启用Redis持久化
- 定期清理日志文件

## 部署检查清单

- [ ] Python 3.11+ 已安装
- [ ] Node.js 18+ 已安装
- [ ] Docker 已安装并运行
- [ ] PostgreSQL 数据库可访问
- [ ] Redis 缓存可访问
- [ ] 后端依赖已安装
- [ ] 前端依赖已安装
- [ ] 环境变量已配置
- [ ] 数据库迁移已完成
- [ ] 服务可正常启动

## 下一步

1. 配置AI模型API密钥
2. 设置数据连接器
3. 配置用户认证
4. 部署到生产环境

完成以上步骤后，Onyx项目应该可以正常运行。如有问题，请查看日志文件或联系技术支持。
