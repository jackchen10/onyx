# Onyx双服务器集群部署配置详解

## 🏗️ 架构概述

### 服务器资源分配

| 服务器 | IP地址 | 配置 | 主要服务 |
|--------|--------|------|----------|
| 主服务器 | 10.0.83.30 | CPU:8核, 内存:32G, 磁盘:100G | 应用服务、搜索引擎、对象存储 |
| 数据库服务器 | 10.0.83.36 | CPU:8核, 内存:32G, 磁盘:100G | PostgreSQL数据库 |

### 服务分布详情

#### 主服务器 (10.0.83.30) 服务清单

| 服务名称 | 容器名 | 端口 | 说明 |
|----------|--------|------|------|
| Nginx反向代理 | onyx-nginx | 80, 443 | 前端入口，负载均衡 |
| Web前端 | onyx-web-server | 3000 | Next.js前端应用 |
| API后端 | onyx-api-server | 8080 | FastAPI后端服务 |
| 推理模型服务器 | onyx-inference-model | 9000 | AI模型推理服务 |
| 索引模型服务器 | onyx-indexing-model | 9001 | 文档索引模型服务 |
| Vespa搜索引擎 | onyx-vespa | 8081, 19071 | 混合检索搜索引擎 |
| MinIO对象存储 | onyx-minio | 9001, 9002 | 文件存储服务 |
| 后台任务处理 | onyx-background | - | Celery后台任务 |
| Redis缓存 | scow-redis-1 | 6379 | 已存在，复用 |

#### 数据库服务器 (10.0.83.36) 服务清单

| 服务名称 | 容器名 | 端口 | 说明 |
|----------|--------|------|------|
| PostgreSQL数据库 | onyx-postgres | 5432 | 主数据库，支持远程访问 |

## ⚙️ 配置文件详解

### 主服务器环境配置 (.env.main)

```bash
# 数据库配置（连接到远程数据库）
POSTGRES_HOST=10.0.83.36
POSTGRES_PORT=5432
POSTGRES_USER=onyx_user
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=onyx

# Redis配置（使用已存在的容器）
REDIS_HOST=10.0.83.30
REDIS_PORT=6379
REDIS_PASSWORD=  # 无密码

# Vespa搜索引擎配置
VESPA_HOST=10.0.83.30
VESPA_PORT=8081
VESPA_TENANT_PORT=19071

# MinIO对象存储配置
S3_ENDPOINT_URL=http://10.0.83.30:9001
S3_AWS_ACCESS_KEY_ID=minioadmin
S3_AWS_SECRET_ACCESS_KEY=minioadmin

# AI模型配置
GEN_AI_API_KEY=your-openai-api-key-here
EMBEDDING_MODEL_SERVER_HOST=10.0.83.30
EMBEDDING_MODEL_SERVER_PORT=9001

# Web服务配置
WEB_DOMAIN=http://10.0.83.30:3000
CORS_ALLOWED_ORIGIN=http://10.0.83.30

# 认证配置
AUTH_TYPE=disabled
SECRET=your-secret-key-here
ENCRYPTION_KEY_SECRET=your-encryption-key-here

# 日志配置
LOG_LEVEL=info
```

### 数据库服务器环境配置 (.env.db)

```bash
# PostgreSQL配置
POSTGRES_HOST=0.0.0.0  # 监听所有接口
POSTGRES_PORT=5432
POSTGRES_USER=onyx_user
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=onyx

# 认证配置
POSTGRES_HOST_AUTH_METHOD=md5
POSTGRES_INITDB_ARGS=--auth-host=md5

# 日志配置
LOG_LEVEL=info
```

## 🔧 Docker Compose配置

### 主服务器配置 (docker-compose.main.yml)

关键配置要点：

1. **网络配置**: 所有服务使用自定义网络 `onyx_network`
2. **依赖关系**: 严格定义服务启动顺序
3. **健康检查**: 每个服务都配置健康检查
4. **资源限制**: 根据服务器配置设置资源限制

```yaml
# 示例：API服务配置
api_server:
  build:
    context: .
    dockerfile: docker/Dockerfile.backend
  container_name: onyx-api-server
  ports:
    - "8080:8080"
  environment:
    - POSTGRES_HOST=10.0.83.36  # 连接远程数据库
    - REDIS_HOST=10.0.83.30     # 使用本地Redis
    - VESPA_HOST=10.0.83.30     # 使用本地Vespa
  env_file:
    - .env.main
  restart: unless-stopped
  depends_on:
    - inference_model_server
    - indexing_model_server
    - minio
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    interval: 30s
    timeout: 10s
    retries: 3
```

### 数据库服务器配置 (docker-compose.db.yml)

```yaml
# PostgreSQL数据库配置
relational_db:
  image: postgres:15-alpine
  container_name: onyx-postgres
  ports:
    - "5432:5432"
  environment:
    POSTGRES_USER: onyx_user
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    POSTGRES_DB: onyx
    POSTGRES_HOST_AUTH_METHOD: md5
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
  command: >
    postgres
    -c config_file=/etc/postgresql/postgresql.conf
    -c hba_file=/etc/postgresql/pg_hba.conf
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U onyx_user -d onyx"]
    interval: 30s
    timeout: 10s
    retries: 3
```

## 🔒 安全配置

### PostgreSQL远程访问配置

#### postgresql.conf 关键配置

```conf
# 网络连接配置
listen_addresses = '*'          # 监听所有IP地址
port = 5432                     # 默认端口

# 连接配置
max_connections = 200           # 最大连接数
shared_buffers = 256MB          # 共享缓冲区
effective_cache_size = 1GB      # 有效缓存大小

# 安全配置
ssl = off                       # 生产环境建议开启SSL
password_encryption = md5       # 密码加密方式

# 日志配置
log_statement = 'all'           # 记录所有SQL语句
log_min_duration_statement = 1000  # 记录慢查询
```

#### pg_hba.conf 访问控制配置

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# 本地连接
local   all             all                                     trust
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5

# 允许主服务器连接
host    all             onyx_user       10.0.83.30/32           md5

# 允许内网连接
host    all             onyx_user       10.0.83.0/24            md5

# 生产环境可以更严格地限制访问
# host    onyx            onyx_user       10.0.83.30/32           md5
```

### 防火墙配置

#### 主服务器防火墙规则

```bash
# 开放Web访问端口
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp

# 开放API端口（可选，通过nginx代理访问）
sudo firewall-cmd --permanent --add-port=8080/tcp

# 开放MinIO端口
sudo firewall-cmd --permanent --add-port=9001/tcp
sudo firewall-cmd --permanent --add-port=9002/tcp

# 开放Vespa端口
sudo firewall-cmd --permanent --add-port=8081/tcp

# 重载防火墙配置
sudo firewall-cmd --reload
```

#### 数据库服务器防火墙规则

```bash
# 开放PostgreSQL端口
sudo firewall-cmd --permanent --add-port=5432/tcp

# 限制访问源（可选）
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='10.0.83.30/32' port protocol='tcp' port='5432' accept"

# 重载防火墙配置
sudo firewall-cmd --reload
```

## 🚀 部署流程详解

### 1. 环境准备阶段

```bash
# 在两台服务器上分别执行
git clone <repository-url> onyx
cd onyx
chmod +x deploy-openeuler-cluster.sh verify-cluster-deployment.sh

# 设置集群环境
./deploy-openeuler-cluster.sh setup-cluster
```

### 2. 配置阶段

#### 主服务器配置
```bash
# 编辑主服务器环境配置
vim .env.main

# 关键配置项检查
grep -E "POSTGRES_HOST|REDIS_HOST|VESPA_HOST" .env.main
```

#### 数据库服务器配置
```bash
# 编辑数据库服务器环境配置
vim .env.db

# 确保密码与主服务器一致
grep POSTGRES_PASSWORD .env.db
```

### 3. 部署阶段

#### 先部署数据库服务器
```bash
# 在数据库服务器 (10.0.83.36) 上执行
./deploy-openeuler-cluster.sh deploy-db

# 验证数据库启动
docker logs onyx-postgres
```

#### 再部署主服务器
```bash
# 在主服务器 (10.0.83.30) 上执行
./deploy-openeuler-cluster.sh deploy-main --build

# 验证服务启动
docker-compose -f deployment/docker_compose/docker-compose.main.yml ps
```

### 4. 验证阶段

```bash
# 在两台服务器上分别执行验证
./verify-cluster-deployment.sh

# 检查集群状态
./deploy-openeuler-cluster.sh status
```

## 🔍 监控与维护

### 服务监控命令

```bash
# 查看所有容器状态
docker ps -a

# 查看服务日志
docker-compose -f deployment/docker_compose/docker-compose.main.yml logs -f

# 查看特定服务日志
docker logs onyx-api-server -f

# 查看资源使用情况
docker stats
```

### 数据库维护

```bash
# 连接数据库
docker exec -it onyx-postgres psql -U onyx_user -d onyx

# 备份数据库
docker exec onyx-postgres pg_dump -U onyx_user onyx > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
docker exec -i onyx-postgres psql -U onyx_user onyx < backup.sql

# 查看数据库大小
docker exec onyx-postgres psql -U onyx_user -d onyx -c "SELECT pg_size_pretty(pg_database_size('onyx'));"
```

### 性能优化建议

#### 主服务器优化
1. **内存分配**: 为Vespa和模型服务器分配足够内存
2. **磁盘IO**: 使用SSD存储提升性能
3. **网络优化**: 调整网络缓冲区大小

#### 数据库服务器优化
1. **PostgreSQL调优**: 根据32GB内存调整配置参数
2. **连接池**: 配置合适的连接池大小
3. **索引优化**: 定期分析和优化索引

## 🐛 故障排除

### 常见问题及解决方案

#### 1. 数据库连接失败
```bash
# 检查网络连通性
ping 10.0.83.36

# 检查端口开放
nc -z 10.0.83.36 5432

# 检查数据库日志
docker logs onyx-postgres

# 测试数据库连接
PGPASSWORD="your_password" psql -h 10.0.83.36 -U onyx_user -d onyx -c "SELECT 1;"
```

#### 2. Redis连接问题
```bash
# 检查Redis容器状态
docker ps | grep scow-redis-1

# 测试Redis连接
docker exec scow-redis-1 redis-cli ping

# 检查Redis配置
docker exec scow-redis-1 redis-cli CONFIG GET "*"
```

#### 3. 服务启动失败
```bash
# 查看详细错误信息
docker-compose -f deployment/docker_compose/docker-compose.main.yml logs --tail=50

# 检查资源使用
free -h
df -h

# 重启服务
docker-compose -f deployment/docker_compose/docker-compose.main.yml restart
```

---

**文档版本**: v1.0  
**最后更新**: 2025-02-19  
**适用版本**: Onyx v1.0+  
**服务器配置**: openEuler 20.03 LTS 双服务器集群
