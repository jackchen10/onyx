# OnyxåŒæœåŠ¡å™¨é›†ç¾¤éƒ¨ç½²é…ç½®è¯¦è§£

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

### æœåŠ¡å™¨èµ„æºåˆ†é…

| æœåŠ¡å™¨ | IPåœ°å€ | é…ç½® | ä¸»è¦æœåŠ¡ |
|--------|--------|------|----------|
| ä¸»æœåŠ¡å™¨ | 10.0.83.30 | CPU:8æ ¸, å†…å­˜:32G, ç£ç›˜:100G | åº”ç”¨æœåŠ¡ã€æœç´¢å¼•æ“ã€å¯¹è±¡å­˜å‚¨ |
| æ•°æ®åº“æœåŠ¡å™¨ | 10.0.83.36 | CPU:8æ ¸, å†…å­˜:32G, ç£ç›˜:100G | PostgreSQLæ•°æ®åº“ |

### æœåŠ¡åˆ†å¸ƒè¯¦æƒ…

#### ä¸»æœåŠ¡å™¨ (10.0.83.30) æœåŠ¡æ¸…å•

| æœåŠ¡åç§° | å®¹å™¨å | ç«¯å£ | è¯´æ˜ |
|----------|--------|------|------|
| Nginxåå‘ä»£ç† | onyx-nginx | 80, 443 | å‰ç«¯å…¥å£ï¼Œè´Ÿè½½å‡è¡¡ |
| Webå‰ç«¯ | onyx-web-server | 3000 | Next.jså‰ç«¯åº”ç”¨ |
| APIåç«¯ | onyx-api-server | 8080 | FastAPIåç«¯æœåŠ¡ |
| æ¨ç†æ¨¡å‹æœåŠ¡å™¨ | onyx-inference-model | 9000 | AIæ¨¡å‹æ¨ç†æœåŠ¡ |
| ç´¢å¼•æ¨¡å‹æœåŠ¡å™¨ | onyx-indexing-model | 9001 | æ–‡æ¡£ç´¢å¼•æ¨¡å‹æœåŠ¡ |
| Vespaæœç´¢å¼•æ“ | onyx-vespa | 8081, 19071 | æ··åˆæ£€ç´¢æœç´¢å¼•æ“ |
| MinIOå¯¹è±¡å­˜å‚¨ | onyx-minio | 9001, 9002 | æ–‡ä»¶å­˜å‚¨æœåŠ¡ |
| åå°ä»»åŠ¡å¤„ç† | onyx-background | - | Celeryåå°ä»»åŠ¡ |
| Redisç¼“å­˜ | scow-redis-1 | 6379 | å·²å­˜åœ¨ï¼Œå¤ç”¨ |

#### æ•°æ®åº“æœåŠ¡å™¨ (10.0.83.36) æœåŠ¡æ¸…å•

| æœåŠ¡åç§° | å®¹å™¨å | ç«¯å£ | è¯´æ˜ |
|----------|--------|------|------|
| PostgreSQLæ•°æ®åº“ | onyx-postgres | 5432 | ä¸»æ•°æ®åº“ï¼Œæ”¯æŒè¿œç¨‹è®¿é—® |

## âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£

### ä¸»æœåŠ¡å™¨ç¯å¢ƒé…ç½® (.env.main)

```bash
# æ•°æ®åº“é…ç½®ï¼ˆè¿æ¥åˆ°è¿œç¨‹æ•°æ®åº“ï¼‰
POSTGRES_HOST=10.0.83.36
POSTGRES_PORT=5432
POSTGRES_USER=onyx_user
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=onyx

# Redisé…ç½®ï¼ˆä½¿ç”¨å·²å­˜åœ¨çš„å®¹å™¨ï¼‰
REDIS_HOST=10.0.83.30
REDIS_PORT=6379
REDIS_PASSWORD=  # æ— å¯†ç 

# Vespaæœç´¢å¼•æ“é…ç½®
VESPA_HOST=10.0.83.30
VESPA_PORT=8081
VESPA_TENANT_PORT=19071

# MinIOå¯¹è±¡å­˜å‚¨é…ç½®
S3_ENDPOINT_URL=http://10.0.83.30:9001
S3_AWS_ACCESS_KEY_ID=minioadmin
S3_AWS_SECRET_ACCESS_KEY=minioadmin

# AIæ¨¡å‹é…ç½®
GEN_AI_API_KEY=your-openai-api-key-here
EMBEDDING_MODEL_SERVER_HOST=10.0.83.30
EMBEDDING_MODEL_SERVER_PORT=9001

# WebæœåŠ¡é…ç½®
WEB_DOMAIN=http://10.0.83.30:3000
CORS_ALLOWED_ORIGIN=http://10.0.83.30

# è®¤è¯é…ç½®
AUTH_TYPE=disabled
SECRET=your-secret-key-here
ENCRYPTION_KEY_SECRET=your-encryption-key-here

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
```

### æ•°æ®åº“æœåŠ¡å™¨ç¯å¢ƒé…ç½® (.env.db)

```bash
# PostgreSQLé…ç½®
POSTGRES_HOST=0.0.0.0  # ç›‘å¬æ‰€æœ‰æ¥å£
POSTGRES_PORT=5432
POSTGRES_USER=onyx_user
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=onyx

# è®¤è¯é…ç½®
POSTGRES_HOST_AUTH_METHOD=md5
POSTGRES_INITDB_ARGS=--auth-host=md5

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
```

## ğŸ”§ Docker Composeé…ç½®

### ä¸»æœåŠ¡å™¨é…ç½® (docker-compose.main.yml)

å…³é”®é…ç½®è¦ç‚¹ï¼š

1. **ç½‘ç»œé…ç½®**: æ‰€æœ‰æœåŠ¡ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œ `onyx_network`
2. **ä¾èµ–å…³ç³»**: ä¸¥æ ¼å®šä¹‰æœåŠ¡å¯åŠ¨é¡ºåº
3. **å¥åº·æ£€æŸ¥**: æ¯ä¸ªæœåŠ¡éƒ½é…ç½®å¥åº·æ£€æŸ¥
4. **èµ„æºé™åˆ¶**: æ ¹æ®æœåŠ¡å™¨é…ç½®è®¾ç½®èµ„æºé™åˆ¶

```yaml
# ç¤ºä¾‹ï¼šAPIæœåŠ¡é…ç½®
api_server:
  build:
    context: .
    dockerfile: docker/Dockerfile.backend
  container_name: onyx-api-server
  ports:
    - "8080:8080"
  environment:
    - POSTGRES_HOST=10.0.83.36  # è¿æ¥è¿œç¨‹æ•°æ®åº“
    - REDIS_HOST=10.0.83.30     # ä½¿ç”¨æœ¬åœ°Redis
    - VESPA_HOST=10.0.83.30     # ä½¿ç”¨æœ¬åœ°Vespa
  env_file:
    - .env.main
  restart: unless-stopped
  depends_on:
    - inference_model_server
    - indexing_model_server
    - minio
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    interval: 30s
    timeout: 10s
    retries: 3
```

### æ•°æ®åº“æœåŠ¡å™¨é…ç½® (docker-compose.db.yml)

```yaml
# PostgreSQLæ•°æ®åº“é…ç½®
relational_db:
  image: postgres:15-alpine
  container_name: onyx-postgres
  ports:
    - "5432:5432"
  environment:
    POSTGRES_USER: onyx_user
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    POSTGRES_DB: onyx
    POSTGRES_HOST_AUTH_METHOD: md5
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
  command: >
    postgres
    -c config_file=/etc/postgresql/postgresql.conf
    -c hba_file=/etc/postgresql/pg_hba.conf
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U onyx_user -d onyx"]
    interval: 30s
    timeout: 10s
    retries: 3
```

## ğŸ”’ å®‰å…¨é…ç½®

### PostgreSQLè¿œç¨‹è®¿é—®é…ç½®

#### postgresql.conf å…³é”®é…ç½®

```conf
# ç½‘ç»œè¿æ¥é…ç½®
listen_addresses = '*'          # ç›‘å¬æ‰€æœ‰IPåœ°å€
port = 5432                     # é»˜è®¤ç«¯å£

# è¿æ¥é…ç½®
max_connections = 200           # æœ€å¤§è¿æ¥æ•°
shared_buffers = 256MB          # å…±äº«ç¼“å†²åŒº
effective_cache_size = 1GB      # æœ‰æ•ˆç¼“å­˜å¤§å°

# å®‰å…¨é…ç½®
ssl = off                       # ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯SSL
password_encryption = md5       # å¯†ç åŠ å¯†æ–¹å¼

# æ—¥å¿—é…ç½®
log_statement = 'all'           # è®°å½•æ‰€æœ‰SQLè¯­å¥
log_min_duration_statement = 1000  # è®°å½•æ…¢æŸ¥è¯¢
```

#### pg_hba.conf è®¿é—®æ§åˆ¶é…ç½®

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             all                                     trust
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5

# å…è®¸ä¸»æœåŠ¡å™¨è¿æ¥
host    all             onyx_user       10.0.83.30/32           md5

# å…è®¸å†…ç½‘è¿æ¥
host    all             onyx_user       10.0.83.0/24            md5

# ç”Ÿäº§ç¯å¢ƒå¯ä»¥æ›´ä¸¥æ ¼åœ°é™åˆ¶è®¿é—®
# host    onyx            onyx_user       10.0.83.30/32           md5
```

### é˜²ç«å¢™é…ç½®

#### ä¸»æœåŠ¡å™¨é˜²ç«å¢™è§„åˆ™

```bash
# å¼€æ”¾Webè®¿é—®ç«¯å£
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp

# å¼€æ”¾APIç«¯å£ï¼ˆå¯é€‰ï¼Œé€šè¿‡nginxä»£ç†è®¿é—®ï¼‰
sudo firewall-cmd --permanent --add-port=8080/tcp

# å¼€æ”¾MinIOç«¯å£
sudo firewall-cmd --permanent --add-port=9001/tcp
sudo firewall-cmd --permanent --add-port=9002/tcp

# å¼€æ”¾Vespaç«¯å£
sudo firewall-cmd --permanent --add-port=8081/tcp

# é‡è½½é˜²ç«å¢™é…ç½®
sudo firewall-cmd --reload
```

#### æ•°æ®åº“æœåŠ¡å™¨é˜²ç«å¢™è§„åˆ™

```bash
# å¼€æ”¾PostgreSQLç«¯å£
sudo firewall-cmd --permanent --add-port=5432/tcp

# é™åˆ¶è®¿é—®æºï¼ˆå¯é€‰ï¼‰
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='10.0.83.30/32' port protocol='tcp' port='5432' accept"

# é‡è½½é˜²ç«å¢™é…ç½®
sudo firewall-cmd --reload
```

## ğŸš€ éƒ¨ç½²æµç¨‹è¯¦è§£

### 1. ç¯å¢ƒå‡†å¤‡é˜¶æ®µ

```bash
# åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡Œ
git clone <repository-url> onyx
cd onyx
chmod +x deploy-openeuler-cluster.sh verify-cluster-deployment.sh

# è®¾ç½®é›†ç¾¤ç¯å¢ƒ
./deploy-openeuler-cluster.sh setup-cluster
```

### 2. é…ç½®é˜¶æ®µ

#### ä¸»æœåŠ¡å™¨é…ç½®
```bash
# ç¼–è¾‘ä¸»æœåŠ¡å™¨ç¯å¢ƒé…ç½®
vim .env.main

# å…³é”®é…ç½®é¡¹æ£€æŸ¥
grep -E "POSTGRES_HOST|REDIS_HOST|VESPA_HOST" .env.main
```

#### æ•°æ®åº“æœåŠ¡å™¨é…ç½®
```bash
# ç¼–è¾‘æ•°æ®åº“æœåŠ¡å™¨ç¯å¢ƒé…ç½®
vim .env.db

# ç¡®ä¿å¯†ç ä¸ä¸»æœåŠ¡å™¨ä¸€è‡´
grep POSTGRES_PASSWORD .env.db
```

### 3. éƒ¨ç½²é˜¶æ®µ

#### å…ˆéƒ¨ç½²æ•°æ®åº“æœåŠ¡å™¨
```bash
# åœ¨æ•°æ®åº“æœåŠ¡å™¨ (10.0.83.36) ä¸Šæ‰§è¡Œ
./deploy-openeuler-cluster.sh deploy-db

# éªŒè¯æ•°æ®åº“å¯åŠ¨
docker logs onyx-postgres
```

#### å†éƒ¨ç½²ä¸»æœåŠ¡å™¨
```bash
# åœ¨ä¸»æœåŠ¡å™¨ (10.0.83.30) ä¸Šæ‰§è¡Œ
./deploy-openeuler-cluster.sh deploy-main --build

# éªŒè¯æœåŠ¡å¯åŠ¨
docker-compose -f deployment/docker_compose/docker-compose.main.yml ps
```

### 4. éªŒè¯é˜¶æ®µ

```bash
# åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡ŒéªŒè¯
./verify-cluster-deployment.sh

# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
./deploy-openeuler-cluster.sh status
```

## ğŸ” ç›‘æ§ä¸ç»´æŠ¤

### æœåŠ¡ç›‘æ§å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps -a

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f deployment/docker_compose/docker-compose.main.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker logs onyx-api-server -f

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
docker stats
```

### æ•°æ®åº“ç»´æŠ¤

```bash
# è¿æ¥æ•°æ®åº“
docker exec -it onyx-postgres psql -U onyx_user -d onyx

# å¤‡ä»½æ•°æ®åº“
docker exec onyx-postgres pg_dump -U onyx_user onyx > backup_$(date +%Y%m%d_%H%M%S).sql

# æ¢å¤æ•°æ®åº“
docker exec -i onyx-postgres psql -U onyx_user onyx < backup.sql

# æŸ¥çœ‹æ•°æ®åº“å¤§å°
docker exec onyx-postgres psql -U onyx_user -d onyx -c "SELECT pg_size_pretty(pg_database_size('onyx'));"
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### ä¸»æœåŠ¡å™¨ä¼˜åŒ–
1. **å†…å­˜åˆ†é…**: ä¸ºVespaå’Œæ¨¡å‹æœåŠ¡å™¨åˆ†é…è¶³å¤Ÿå†…å­˜
2. **ç£ç›˜IO**: ä½¿ç”¨SSDå­˜å‚¨æå‡æ€§èƒ½
3. **ç½‘ç»œä¼˜åŒ–**: è°ƒæ•´ç½‘ç»œç¼“å†²åŒºå¤§å°

#### æ•°æ®åº“æœåŠ¡å™¨ä¼˜åŒ–
1. **PostgreSQLè°ƒä¼˜**: æ ¹æ®32GBå†…å­˜è°ƒæ•´é…ç½®å‚æ•°
2. **è¿æ¥æ± **: é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°
3. **ç´¢å¼•ä¼˜åŒ–**: å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 10.0.83.36

# æ£€æŸ¥ç«¯å£å¼€æ”¾
nc -z 10.0.83.36 5432

# æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
docker logs onyx-postgres

# æµ‹è¯•æ•°æ®åº“è¿æ¥
PGPASSWORD="your_password" psql -h 10.0.83.36 -U onyx_user -d onyx -c "SELECT 1;"
```

#### 2. Redisè¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥Rediså®¹å™¨çŠ¶æ€
docker ps | grep scow-redis-1

# æµ‹è¯•Redisè¿æ¥
docker exec scow-redis-1 redis-cli ping

# æ£€æŸ¥Redisé…ç½®
docker exec scow-redis-1 redis-cli CONFIG GET "*"
```

#### 3. æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
docker-compose -f deployment/docker_compose/docker-compose.main.yml logs --tail=50

# æ£€æŸ¥èµ„æºä½¿ç”¨
free -h
df -h

# é‡å¯æœåŠ¡
docker-compose -f deployment/docker_compose/docker-compose.main.yml restart
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-02-19  
**é€‚ç”¨ç‰ˆæœ¬**: Onyx v1.0+  
**æœåŠ¡å™¨é…ç½®**: openEuler 20.03 LTS åŒæœåŠ¡å™¨é›†ç¾¤
